<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App</title>
  </head>
  <script>
    const clientId =
      "2a3af50d2da12999c7344da5c4aed0d065824ce3b329ec05f05bdaf3ccdee5cb";
    const scope = "access";
    const redirectUri = "http://localhost:8788/app";
    const tokenUrl = "http://localhost:8787/token";

    const getHexStringFromBuffer = (buffer) => {
      return Array.from(new Uint8Array(buffer))
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
    };

    const authorize = async () => {
      const codeVerifier = getHexStringFromBuffer(
        await crypto.getRandomValues(new Uint8Array(32))
      );

      const storage = window.sessionStorage;
      storage.clear();
      storage.setItem("code_verifier", codeVerifier);

      const codeChallenge = getHexStringFromBuffer(
        await crypto.subtle.digest(
          "SHA-256",
          new TextEncoder().encode(codeVerifier)
        )
      );
      const base64UrlEncodedCodeChallenge = btoa(codeChallenge)
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");

      const loginUrl = `http://localhost:8787/authorize?response_type=code&client_id=${encodeURIComponent(
        clientId
      )}&redirect_uri=${encodeURIComponent(
        redirectUri
      )}&scope=${scope}&code_challenge=${base64UrlEncodedCodeChallenge}&code_challenge_method=S256`;

      window.location = loginUrl;
    };

    const getToken = async () => {
      const storage = window.sessionStorage;
      const codeVerifier = storage.getItem("code_verifier");
      storage.clear();

      const tokenResponse = await fetch(tokenUrl, {
        method: "POST",
        body: new URLSearchParams({
          grant_type: "authorization_code",
          client_id: clientId,
          redirect_uri: redirectUri,
          code_verifier: codeVerifier,
          scope,
          code,
        }),
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
      });

      if (tokenResponse.status !== 200) {
        authorize();
      }

      console.log(await tokenResponse.json());
    };

    const url = new URL(window.location.href);
    const searchParams = Object.fromEntries(url.searchParams);
    const code = searchParams.code;

    if (code) {
      getToken();
    } else {
      authorize();
    }
  </script>

  <body>
    <h1>App</h1>
  </body>
</html>
